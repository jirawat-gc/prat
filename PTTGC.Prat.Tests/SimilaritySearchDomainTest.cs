using PTTGC.Prat.Backend.Domains;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace PTTGC.Prat.Tests;

[TestClass]
public class SimilaritySearchDomainTest
{
    [TestInitialize]
    public void Setup()
    {
        Util.InitConfiguration();
    }

    private readonly double[] TEST_EMBEDDING = [-0.03212973102927208,0.020736634731292725,-0.07044928520917892,0.01183347124606371,0.025884050875902176,0.013124904595315456,0.008187446743249893,-0.03809947147965431,0.03436962142586708,-0.025602929294109344,0.035920433700084686,-0.005013831425458193,-0.03090912103652954,-0.0016778138233348727,-0.015797659754753113,0.0024853849317878485,0.018882600590586662,0.03569991886615753,0.009073962457478046,-0.08175751566886902,0.060827333480119705,0.00404685502871871,0.023270919919013977,-0.09226469695568085,0.01444836612790823,-0.01027351152151823,0.02352149412035942,-0.052309855818748474,-0.05865038186311722,0.021615391597151756,-0.05959261953830719,0.10484639555215836,-0.07243412733078003,-0.018966032192111015,-0.0025471188127994537,-0.05957670137286186,-0.012950286269187927,-0.0006848964258097112,-0.016094110906124115,0.06573987007141113,0.00552003039047122,0.055036574602127075,-0.026045791804790497,-0.026633257046341896,0.008230057545006275,-0.047102149575948715,-0.04896632954478264,0.012239203788340092,-0.031088275834918022,-0.07180710881948471,0.0035595532972365618,0.01624542661011219,0.015827437862753868,-0.02964349091053009,0.008511153981089592,-0.00825922004878521,0.036186400800943375,-0.0029768964741379023,0.009578654542565346,-0.007975716143846512,-0.02446272224187851,0.04506988450884819,-0.036282386630773544,-0.02413339540362358,0.015805797651410103,-0.059245236217975616,-0.04694022983312607,0.017895538359880447,0.05716199427843094,0.0006261084927245975,-0.009373766370117664,-0.007781162858009338,0.0562690831720829,-0.027850579470396042,-0.05980175361037254,-0.08422593027353287,0.000751925865188241,0.010733471252024174,0.015500969253480434,0.018653592094779015,-0.049522072076797485,0.01080884225666523,0.011972866021096706,-0.050287097692489624,-0.019047828391194344,0.013004042208194733,0.003888018662109971,-0.005378233268857002,0.059730980545282364,0.051803767681121826,-0.03978542611002922,-0.00908319279551506,0.012974697165191174,-0.0936104953289032,0.004628822673112154,0.0008340337662957609,-0.02400371804833412,-0.06564179807901382,0.0022554362658411264,0.0001667342585278675,0.03251662850379944,0.009918766096234322,-0.011542996391654015,0.01328311488032341,0.04166674241423607,0.06801214814186096,-0.014548106119036674,0.051950566470623016,-0.027757324278354645,0.030694039538502693,-0.06158884987235069,-0.012611735612154007,-0.04791288822889328,0.0007309060893021524,0.061671726405620575,0.014445407316088676,-0.025362828746438026,0.03962898999452591,0.011311816982924938,0.008294460363686085,0.0004966930719092488,-0.011627152562141418,0.04595271125435829,0.0202740877866745,0.01898500882089138,0.014803295955061913,0.03509117662906647,0.04148108512163162,0.06059648096561432,0.02725924924015999,-0.045973870903253555,-0.0690188780426979,-0.008198755793273449,0.01494341529905796,0.02876325510442257,0.08535921573638916,0.046887606382369995,0.051648158580064774,0.0790252834558487,0.05192068591713905,0.019566038623452187,0.05035391077399254,-0.030315516516566277,0.03970951959490776,-0.013168097473680973,-0.0055742571130394936,0.03975227102637291,0.008868172764778137,0.06592856347560883,0.009938779287040234,0.03596916422247887,-0.021965019404888153,-0.035507682710886,0.02959069237112999,0.0762353166937828,-0.026132604107260704,-0.0010406032670289278,0.013636752963066101,-0.0008449903107248247,0.001741371932439506,0.027481792494654655,-0.021902017295360565,-0.003809958463534713,-0.013172348029911518,0.022007038816809654,-0.033185381442308426,0.015062558464705944,-0.027671057730913162,-0.005628754384815693,-0.006524466909468174,-0.01606103405356407,0.015234464779496193,-0.03068244829773903,-0.014526217244565487,0.0007501734071411192,-0.029933815822005272,0.010895369574427605,0.003469943068921566,-0.03478020802140236,0.03643898665904999,-0.02838430367410183,-0.0359053872525692,-0.01082299929112196,0.009427175857126713,0.032123759388923645,-0.035479310899972916,0.028017546981573105,-0.024002917110919952,-0.01991528645157814,-0.07041487842798233,-0.03549184277653694,0.014129246585071087,0.0020088038872927427,0.024323703721165657,0.03700084984302521,0.06933000683784485,-0.02713063731789589,-0.03900641202926636,-0.0022524110972881317,0.007876044139266014,-0.028744230046868324,0.1033153384923935,0.01151201780885458,0.014168535359203815,0.027804024517536163,-0.04816124588251114,0.08186621218919754,-0.028234854340553284,-0.010223888792097569,0.04575400799512863,-0.00568035151809454,0.05288012698292732,-0.03312832862138748,0.04606068134307861,0.034122731536626816,0.05503680184483528,0.016363447532057762,0.014663422480225563,-0.008839890360832214,-0.039626553654670715,0.007775719277560711,-0.002828743075951934,-0.013159926980733871,0.061054181307554245,0.010014213621616364,0.028567558154463768,-0.015780912712216377,0.01405397243797779,-0.0259479321539402,-0.07651322335004807,0.0019403711194172502,0.05344244837760925,0.003654146334156394,-0.015592725947499275,0.051700659096241,-0.022050045430660248,0.021192440763115883,0.010971929877996445,-0.009742454625666142,0.015061858110129833,-0.04899352416396141,0.05391009896993637,0.020334478467702866,-0.0017946385778486729,0.035217054188251495,-0.017976688221096992,0.006283047143369913,0.06512736529111862,-0.04577256739139557,0.03619398921728134,-0.0232444666326046,-0.05147872492671013,0.015353127382695675,-0.0016428488306701183,-0.04476036876440048,0.031067879870533943,-0.028464671224355698,0.007086236961185932,0.0005321772769093513,-0.031638044863939285,0.03144076094031334,-0.030600370839238167,-0.058237429708242416,-0.04625002294778824,-0.03178619593381882,0.02043585106730461,-0.0484282523393631,-0.06843360513448715,0.002291644923388958,0.04338295757770538,-0.013128386810421944,-0.036287009716033936,0.044562581926584244,0.022389128804206848,-0.009390179067850113,0.03427784889936447,0.02264404110610485,0.07071370631456375,0.010013127699494362,-0.00943195540457964,0.023044688627123833,-1.21195462270407E-05,0.049861788749694824,-0.028804052621126175,-0.03301190212368965,0.011366225779056549,0.008654319681227207,-0.008896208368241787,-0.03229628503322601,-0.009335018694400787,-0.06985775381326675,-0.0020563795696944,-0.04427384212613106,-0.01175951212644577,-0.022757280617952347,-0.03915170580148697,-0.01100094523280859,0.060344018042087555,0.03331536427140236,-0.013705704361200333,-0.01080236304551363,-0.044311996549367905,0.002259724074974656,-0.04940769821405411,-0.016527516767382622,0.027344444766640663,-0.009832079522311687,-0.04979120194911957,-0.0008979323320090771,-0.028043629601597786,0.01973242126405239,0.018774233758449554,-0.025080649182200432,-0.023197488859295845,0.031043510884046555,0.020156703889369965,-0.028700245544314384,0.002596890088170767,-0.039006903767585754,0.03688892722129822,-0.04062396660447121,0.02661634050309658,0.040708981454372406,-0.05364034324884415,0.019260743632912636,0.01109282486140728,-0.037277400493621826,0.04902426525950432,-0.035928864032030106,0.021136274561285973,-0.019606901332736015,0.011059554293751717,-0.004233328625559807,0.030381646007299423,0.015175698325037956,0.05031673237681389,-0.09334173053503036,0.011960987001657486,-0.033511772751808167,0.008262824267148972,0.057009290903806686,-0.023083806037902832,-0.062272123992443085,-0.009418534114956856,-0.04867139458656311,-0.037359416484832764,-0.021095987409353256,0.026283198967576027,0.10271546244621277,0.0262235589325428,0.012262781150639057,0.047711580991744995,-0.060808949172496796,-0.003951555117964745,0.01361966785043478,-0.04332965612411499,0.04782945290207863,-0.0750596672296524,-0.021579770371317863,-0.04604148119688034,-0.036788493394851685,0.029265878722071648,0.015116694383323193,-0.012038804590702057,-0.005552079062908888,0.03143829107284546,-0.019276294857263565,0.017876945436000824,-0.031169187277555466,0.006268315948545933,0.04095587506890297,-0.07654844224452972,0.056393884122371674,-0.03828588128089905,-0.035297539085149765,-0.027911044657230377,-0.021748004481196404,-0.029061011970043182,0.03557476028800011,0.0013778465799987316,0.05192689597606659,-0.032512884587049484,0.04102213308215141,0.031037282198667526,0.021286141127347946,-0.034089285880327225,0.020346030592918396,0.015170597471296787,0.012823294848203659,0.04135509207844734,-0.022665008902549744,-0.043552689254283905,0.07555056363344193,0.06102278083562851,0.013070172630250454,-0.01730840466916561,0.01244769524782896,0.011581000871956348,0.048241183161735535,0.05076172202825546,-0.04096269607543945,-0.05513470992445946,-0.07988719642162323,-0.05103973299264908,-0.02868168242275715,-0.03802657872438431,0.015986260026693344,-0.07873156666755676,-0.014107543043792248,-0.0386345200240612,-0.04229340702295303,0.027235623449087143,0.02230585739016533,-0.036842260509729385,-0.06518971174955368,-0.049468569457530975,0.058952342718839645,-0.011606063693761826,-0.016605446115136147,0.02470463514328003,-0.017414817586541176,0.037431713193655014,-0.004550722427666187,-0.027149753645062447,0.009023796766996384,-0.05994924157857895,-0.02133326791226864,-0.022650113329291344,0.012778274714946747,0.05984152480959892,0.015885181725025177,-0.00210834969766438,-0.006286425981670618,-0.020475950092077255,-0.023632783442735672,-0.01526162214577198,-0.017647430300712585,0.04634217545390129,-0.06978185474872589,0.012588020414113998,0.04832359775900841,-0.0035570026375353336,0.06778032332658768,-0.09359753876924515,-0.0028454612474888563,-0.023353904485702515,0.01165558211505413,-0.04709024354815483,-0.02375055104494095,-0.0541003942489624,0.00511905224993825,-0.058320704847574234,0.004388883709907532,-0.009921535849571228,-0.01771053671836853,-0.03900307044386864,-0.03615138679742813,0.06000758334994316,0.05919390171766281,0.038547296077013016,0.062056005001068115,-0.016547078266739845,0.03057522512972355,-0.10007347166538239,0.06552188843488693,-0.009438942186534405,0.04475885629653931,-0.06572412699460983,0.08837028592824936,0.0748988464474678,0.013961968943476677,0.025467369705438614,-0.02612931653857231,0.014323458075523376,0.007720432244241238,-0.02112468332052231,-0.05773751810193062,0.05781025066971779,-0.018342040479183197,-0.023875363171100616,0.024876171723008156,0.024200016632676125,0.058698732405900955,0.0315794013440609,-0.038586732000112534,0.002603830536827445,-0.023867905139923096,-0.016016962006688118,-0.013198628090322018,0.016992302611470222,-0.014941046014428139,0.0022870078682899475,0.0058478377759456635,-0.03628823533654213,-0.029273195192217827,0.025625234469771385,-0.02924381196498871,0.03950824961066246,-0.008585069328546524,0.0022779253777116537,0.03528708964586258,5.754837911808863E-05,0.031317904591560364,0.027082830667495728,0.05276861786842346,-0.04410538449883461,-0.016486672684550285,0.011399555951356888,-0.0014667398063465953,0.02764832228422165,-0.0008243774645961821,-0.03049628995358944,0.005173330195248127,-0.0029159283731132746,0.02356923185288906,-0.018207473680377007,0.014418775215744972,0.019666103646159172,0.02248009853065014,-0.002834340324625373,0.01157686673104763,-0.01776190474629402,-0.1007973700761795,-0.032899294048547745,0.02359459176659584,-0.08898361027240753,-0.008726525120437145,0.03664698824286461,-0.039992861449718475,-0.0034728797618299723,0.010943233035504818,0.05611812695860863,-0.08787889778614044,-0.0027576966676861048,-0.0028712921775877476,-0.02379968762397766,0.0103846974670887,0.07049079984426498,0.02775288186967373,0.007615750189870596,0.024623028934001923,-0.0030445714946836233,0.007317634299397469,0.02918035350739956,0.015775900334119797,-0.009720848873257637,0.005181492306292057,-0.08436842262744904,0.014279458671808243,-0.027619512751698494,0.02941467985510826,-0.027122389525175095,-0.005772953387349844,-0.08801282942295074,0.024573391303420067,-0.004434388130903244,-0.05614294111728668,0.020240578800439835,0.036641925573349,-0.0028372628148645163,-0.021592309698462486,-0.020507661625742912,0.026318911463022232,-0.018415542319417,0.0444093719124794,0.029890157282352448,-0.02060762420296669,-0.06803696602582932,0.05233210325241089,-0.032986730337142944,-0.0019256731029599905,-0.014911114238202572,-0.020243100821971893,0.03882913663983345,0.027817081660032272,0.028612803667783737,-0.025557242333889008,0.01011616364121437,0.0014984012814238667,0.016077697277069092,0.021617647260427475,0.04463890194892883,-0.0011460789246484637,0.06476631760597229,0.021979790180921555,0.03723076358437538,0.05800795927643776,-0.033743880689144135,-0.022684235125780106,-0.008991993963718414,-0.028104573488235474,0.04681124538183212,-0.06724198162555695,-0.020367704331874847,-0.0029882921371608973,0.01279379054903984,-0.001512888353317976,0.004083484411239624,0.015245914459228516,-0.021555056795477867,0.020711231976747513,-0.05752141401171684,0.03164202347397804,-0.04215439781546593,0.058226097375154495,-0.01780250109732151,-0.021747669205069542,-0.035052355378866196,-0.015078571625053883,-0.02868056483566761,-0.007072518114000559,-0.007123778574168682,0.04702575132250786,0.011908795684576035,-6.387331086443737E-05,-0.03222324699163437,0.041476644575595856,-0.027911152690649033,-0.03281543403863907,-0.0746934786438942,0.012627066113054752,-0.027216725051403046,-0.03363459184765816,0.030715985223650932,0.03697381168603897,-0.019564609974622726,-0.020233293995261192,0.020166967064142227,0.016416197642683983,0.008948295377194881,-0.012981122359633446,0.05074184015393257,0.022331897169351578,-0.026189882308244705,-0.009878484532237053,-0.0015810157638043165,-0.0241696797311306,-0.048466719686985016,-0.03790104389190674,-0.014568259008228779,-0.0760214701294899,-0.011410532519221306,0.04854849725961685,-0.006999350618571043,-0.02787313424050808,0.029459252953529358,0.029696155339479446,-0.08211467415094376,-0.01563642919063568,-0.014354437589645386,0.029879126697778702,-0.0015201529022306204,0.01653968170285225,-0.0211712084710598,0.012453349307179451,-0.010362566448748112,-0.003008901374414563,-0.022470150142908096,0.007808257360011339,0.0009732843609526753,-0.04253191873431206,0.03818776458501816,-0.0018395025981590152,-0.022127702832221985,-0.009759722277522087,0.03109038434922695,-0.07748236507177353,-0.06741411238908768,0.00841983500868082,0.027344737201929092,-0.023738950490951538,0.04024605453014374,0.010007744655013084,0.0011011183960363269,-0.007740981876850128,-0.01110527478158474,-0.023639613762497902,0.023672910407185555,0.00618950417265296,0.030327657237648964,0.04342076927423477,-0.03959224000573158,0.002008948940783739,0.03044648841023445,0.04906787350773811,0.011026732623577118,-0.013843134045600891,-0.00704116141423583,-0.06104452162981033,0.025224383920431137,0.06373816728591919,-0.049712613224983215,0.019400766119360924,-0.021247217431664467,0.02347603440284729,0.08583622425794601,-0.06819286942481995,0.027473023161292076,0.011391077190637589,0.027573904022574425,0.02028668485581875,-0.014744329266250134,0.01876128651201725,-0.0031172267626971006,-0.009147195145487785,-0.008028952404856682,-0.006563458126038313,0.013867665082216263,0.06539397686719894,0.0035995221696794033,-0.023185880854725838,-0.025147845968604088,-0.04555420204997063,0.049391359090805054,0.05153435841202736,0.004543662071228027,0.04811538755893707,-0.017022086307406425,-0.018154984340071678,0.09047536551952362,0.02910364605486393,0.016040874645113945,0.028652597218751907,-0.05952277034521103,-0.04155801236629486,0.025039171800017357,0.008278217166662216,0.020881960168480873,0.001847792067565024,-0.014701089821755886,0.019703250378370285,-0.012214857153594494,-0.04628030210733414,0.03198518604040146,-0.028757425025105476,0.047934748232364655,0.024574100971221924,-0.013030094094574451,-0.027583075687289238,-0.08262667804956436,0.011628399603068829,0.0012129610404372215,0.009418930858373642,0.05944175645709038,0.022609734907746315,-0.052468087524175644,0.014373352751135826,-0.007522759027779102,0.07633062452077866,-0.023301074281334877,-0.029213571920990944,-0.009927586652338505,0.035127297043800354,0.026424089446663857,0.0010301941074430943,-0.04357777535915375,0.02260853722691536,0.01616748608648777,-0.010344129987061024,0.019374676048755646,-0.04451831430196762,0.03909565508365631,-0.02224305272102356,0.037997230887413025,0.01899551972746849,0.005739108193665743,-0.06304045766592026,0.021589362993836403];

    [TestMethod]
    public async Task FindCluster()
    {
        var result = await SimilaritySearchDomain.FindMatches(TEST_EMBEDDING);

        Assert.IsTrue(result.All(p => string.IsNullOrEmpty(p.Title) == false));
        Assert.IsTrue(result.All(p => p.Analysis.TextEmbeddingSimilarity > 0));
    }
}
